<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>× ×™×”×•×œ ××¢×¨×›×ª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f8f9fa; font-family: sans-serif; margin: 0; overflow-x: hidden; }
        
        /* ×¡×¨×’×œ ×¦×“ - ×¢×™×¦×•×‘ ×œ××—×©×‘ */
        .sidebar { 
            width: 250px; height: 100vh; background: #2b2d42; color: white; 
            position: fixed; right: 0; top: 0; padding: 20px; 
            display: flex; flex-direction: column; z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        /* ×ª×•×›×Ÿ ×¨××©×™ - ×¢×™×¦×•×‘ ×œ××—×©×‘ */
        .main { margin-right: 250px; padding: 30px; transition: margin 0.3s ease; }
        
        /* ×›×¤×ª×•×¨ ×ª×¤×¨×™×˜ ×œ× ×™×™×“ */
        .menu-toggle { display: none; position: fixed; top: 15px; right: 15px; z-index: 1100; background: #2b2d42; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }

        /* ×›×¤×ª×•×¨×™ × ×™×•×•×˜ */
        .nav-btn { color: #ddd; text-decoration: none; padding: 12px; display: block; border-radius: 8px; margin-bottom: 5px; cursor: pointer; }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.1); color: white; }
        
        /* ×›×¨×˜×™×¡×™×•×ª */
        .stat-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; text-align: center; }
        .table-card { background: white; border-radius: 15px; border: none; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* --- ×”×ª×××” ×œ× ×™×™×“ (Mobile) --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); width: 260px; box-shadow: -5px 0 15px rgba(0,0,0,0.2); } /* ××•×¡×ª×¨ ×™××™× ×” */
            .sidebar.active { transform: translateX(0); } /* ××•×¦×’ */
            .main { margin-right: 0; padding: 15px; padding-top: 70px; } /* ×¨×•×•×— ××œ××¢×œ×” ×œ×›×¤×ª×•×¨ */
            .menu-toggle { display: block; } /* ×”×¦×’×ª ×›×¤×ª×•×¨ ×”×ª×¤×¨×™×˜ */
            
            /* ×”×ª×××ª ×›×¨×˜×™×¡×™×•×ª ×œ×©×•×¨×” ××—×ª */
            .stat-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
            .stat-col { min-width: 140px; flex: 1; }
            
            /* ×¤×™×œ×˜×¨×™× ×‘×˜×•×¨ */
            .filter-bar { flex-direction: column; gap: 10px; }
            .filter-bar input { width: 100% !important; }
        }

        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<button class="menu-toggle shadow" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
</button>

<div id="login-overlay">
    <div class="text-center p-4 border rounded shadow-sm bg-white mx-3" style="max-width: 350px; width: 100%;">
        <h3>×›× ×™×¡×ª ×× ×”×œ</h3>
        <input type="password" id="admin-pass" class="form-control text-center my-3" placeholder="×¡×™×¡××”">
        <button class="btn btn-primary w-100" onclick="login()">×›× ×™×¡×”</button>
    </div>
</div>

<div class="sidebar shadow" id="sidebar">
    <h4 class="fw-bold mb-4 mt-2">× ×™×”×•×œ ×§×•×¤×”</h4>
    <div class="nav-btn active" onclick="closeMenu()"><i class="fas fa-home me-2"></i> ×¨××©×™</div>
    <div class="nav-btn" onclick="openPush(); closeMenu()"><i class="fas fa-paper-plane me-2"></i> ×©×œ×— ×”×•×“×¢×”</div>
    <div class="nav-btn" onclick="recalc(); closeMenu()"><i class="fas fa-sync me-2"></i> ×ª×™×§×•×Ÿ ×¡×›×•××™×</div>
    <div class="mt-auto nav-btn text-danger" onclick="location.reload()"><i class="fas fa-sign-out-alt me-2"></i> ×™×¦×™××”</div>
</div>

<div id="backdrop" onclick="closeMenu()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:999;"></div>

<div class="main" id="main" style="display: none;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0 fs-3">×œ×•×— ×‘×§×¨×”</h2>
    </div>

    <div class="d-flex filter-bar mb-4 bg-white p-2 rounded shadow-sm">
        <input type="text" id="search" class="form-control border-0" placeholder="ğŸ” ×—×™×¤×•×©..." onkeyup="filter()">
        <div class="border-start mx-1 d-none d-md-block"></div>
        <input type="date" id="date-filter" class="form-control border-0" onchange="filter()">
    </div>

    <div class="stat-row mb-4">
        <div class="stat-col"><div class="stat-card border-bottom border-4 border-primary">
            <small class="text-muted d-block">×¡×”"×› × ×ª×¨×</small><h4 class="fw-bold m-0 text-primary" id="s-total">â‚ª0</h4>
        </div></div>
        <div class="stat-col"><div class="stat-card border-bottom border-4 border-success">
            <small class="text-muted d-block">××©×ª××©×™×</small><h4 class="fw-bold m-0 text-success" id="s-users">0</h4>
        </div></div>
        <div class="stat-col"><div class="stat-card border-bottom border-4 border-warning">
            <small class="text-muted d-block">×ª×¨×•××•×ª</small><h4 class="fw-bold m-0 text-warning" id="s-count">0</h4>
        </div></div>
    </div>

    <div class="card table-card">
        <div class="card-header bg-white d-flex justify-content-between py-3">
            <span class="fw-bold">××©×ª××©×™×</span>
            <span class="badge bg-light text-dark border" id="rows-count">0</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle" style="min-width: 600px;"> <thead class="table-light"><tr><th>×©×</th><th>×¤×¨×˜×™×</th><th>××–×”×™×</th><th>×¡×”"×›</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header fw-bold">×¢×¨×™×›×”</div>
    <div class="modal-body">
        <input type="hidden" id="e-id">
        <label>×©×</label><input type="text" id="e-name" class="form-control mb-2">
        <label>×˜×œ×¤×•×Ÿ</label><input type="text" id="e-phone" class="form-control mb-2">
        <label>××™×™×œ</label><input type="text" id="e-email" class="form-control mb-2">
        <label>×ª"×–</label><input type="text" id="e-tz" class="form-control mb-2">
        <label class="text-danger">Token</label><input type="text" id="e-token" class="form-control mb-3 text-danger">
        <button class="btn btn-primary w-100" onclick="save()">×©××•×¨</button>
    </div>
</div></div></div>

<div class="modal fade" id="pushModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header fw-bold bg-primary text-white">×©×œ×™×—×ª ×”×•×“×¢×”</div>
    <div class="modal-body">
        <input type="text" id="p-title" class="form-control mb-2" placeholder="×›×•×ª×¨×ª">
        <textarea id="p-body" class="form-control mb-3" placeholder="×ª×•×›×Ÿ"></textarea>
        <button class="btn btn-primary w-100" onclick="sendPush()">×©×œ×—</button>
    </div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "https://pushcoins-server.onrender.com";
    const PASS = "admin1234";
    let users = [];
    let editModalObj, pushModalObj;

    document.addEventListener('DOMContentLoaded', function() {
        editModalObj = new bootstrap.Modal(document.getElementById('editModal'));
        pushModalObj = new bootstrap.Modal(document.getElementById('pushModal'));
    });

    // --- ×œ×•×’×™×§×” ×œ× ×™×™×“ ---
    function toggleMenu() {
        const sb = document.getElementById('sidebar');
        const bd = document.getElementById('backdrop');
        sb.classList.toggle('active');
        bd.style.display = sb.classList.contains('active') ? 'block' : 'none';
    }
    function closeMenu() {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('backdrop').style.display = 'none';
    }

    function login() {
        if(document.getElementById('admin-pass').value === PASS) {
            document.getElementById('login-overlay').classList.add('d-none');
            document.getElementById('main').style.display = 'block';
            loadData();
        } else Swal.fire('×©×’×™××”', '×¡×™×¡××” ×©×’×•×™×”', 'error');
    }

    async function loadData() {
        try {
            // ×¡×˜×˜×™×¡×˜×™×§×”
            fetch(`${API}/admin/stats`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:PASS})})
                .then(r=>r.json()).then(d=>{ if(d.success) {
                    document.getElementById('s-total').innerText = 'â‚ª' + d.stats.totalDonated.toLocaleString();
                    document.getElementById('s-users').innerText = d.stats.totalUsers;
                }});

            // ××©×ª××©×™×
            const res = await fetch(`${API}/admin/get-users`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:PASS})});
            
            // ×‘×“×™×§×” ×©×–×” ×œ× HTML (×©×’×™××” × ×¤×•×¦×” ×‘×©×¨×ª ×œ× ××¢×•×“×›×Ÿ)
            const text = await res.text();
            try {
                const data = JSON.parse(text);
                if(data.success) {
                    users = data.users;
                    filter();
                } else { Swal.fire('×©×’×™××” ×‘×˜×¢×™× ×”', '', 'error'); }
            } catch(e) {
                console.error("HTML Error:", text);
                Swal.fire('×©×’×™××ª ×©×¨×ª', '× × ×œ×¢×“×›×Ÿ ××ª server.js', 'error');
            }
        } catch(e) { Swal.fire('×©×’×™××ª ×ª×§×©×•×¨×ª', '', 'error'); }
    }

    function filter() {
        const q = document.getElementById('search').value.toLowerCase();
        const date = document.getElementById('date-filter').value;
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        const filtered = users.filter(u => {
            const txt = (u.name+u.phone+u.email+u.tz).toLowerCase();
            if(!txt.includes(q)) return false;
            if(date) {
                const last = u.donationsHistory?.length ? new Date(u.donationsHistory[u.donationsHistory.length-1].date).toISOString().split('T')[0] : '';
                if(last !== date) return false;
            }
            return true;
        });

        document.getElementById('rows-count').innerText = filtered.length;

        filtered.forEach(u => {
            tbody.innerHTML += `<tr>
                <td><b>${u.name||'-'}</b></td>
                <td><small>${u.phone||''}<br>${u.email||''}</small></td>
                <td><small>${u.tz||'-'}</small><br>${u.token?'âœ…':'âŒ'}</td>
                <td class="text-success fw-bold">â‚ª${u.totalDonated}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="openEdit('${u._id}')"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="del('${u._id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    function openEdit(id) {
        const u = users.find(x => x._id === id);
        if(!u) return;
        document.getElementById('e-id').value = u._id;
        document.getElementById('e-name').value = u.name||'';
        document.getElementById('e-phone').value = u.phone||'';
        document.getElementById('e-email').value = u.email||'';
        document.getElementById('e-tz').value = u.tz||'';
        document.getElementById('e-token').value = u.token||'';
        editModalObj.show();
    }

    function openPush() { pushModalObj.show(); }

    async function save() {
        const id = document.getElementById('e-id').value;
        const data = {
            name: document.getElementById('e-name').value,
            phone: document.getElementById('e-phone').value,
            email: document.getElementById('e-email').value,
            tz: document.getElementById('e-tz').value,
            token: document.getElementById('e-token').value
        };
        Swal.fire({title:'×©×•××¨...', didOpen:()=>Swal.showLoading()});
        await fetch(`${API}/admin/update-user-full`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:PASS, userId:id, userData:data})});
        editModalObj.hide();
        Swal.fire('× ×©××¨', '', 'success');
        loadData();
    }

    async function del(id) {
        if(confirm('×œ××—×•×§ ×œ×¦××™×ª×•×ª?')) {
            await fetch(`${API}/admin/delete-user`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:PASS, userId:id})});
            loadData();
        }
    }

    async function recalc() {
        Swal.fire({title:'××ª×§×Ÿ...', didOpen:()=>Swal.showLoading()});
        const res = await fetch(`${API}/admin/recalc-totals`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:PASS})});
        const d = await res.json();
        Swal.fire(d.success?'×‘×•×¦×¢':'×©×’×™××”', d.success?`×¢×•×“×›× ×• ${d.count}`:d.error, d.success?'success':'error');
        loadData();
    }

    async function sendPush() {
        const title = document.getElementById('p-title').value;
        const body = document.getElementById('p-body').value;
        pushModalObj.hide();
        Swal.fire({title:'×©×•×œ×—...', didOpen:()=>Swal.showLoading()});
        const res = await fetch(`${API}/admin/send-push`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:PASS, title, body})});
        const d = await res.json();
        Swal.fire(d.success?'× ×©×œ×—':'×©×’×™××”', '', d.success?'success':'error');
    }
</script>
</body>
</html>
