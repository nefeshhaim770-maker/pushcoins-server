<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>× ×™×”×•×œ ××¢×¨×›×ª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body{background:#f8f9fa;}</style>
</head>
<body>

<div class="container py-4 d-none" id="admin-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ğŸ›¡ï¸ × ×™×”×•×œ ×§×•×¤×”</h3>
        <div>
            <button class="btn btn-dark" onclick="openPushModal()">ğŸ“¢ ×”×•×“×¢×” ×œ×›×•×œ×</button>
            <button class="btn btn-outline-secondary" onclick="location.reload()">ğŸ”„</button>
        </div>
    </div>

    <div class="row g-2 mb-4 text-center">
        <div class="col-6 col-md-3"><div class="card p-2 border-primary"><h4 class="text-primary m-0" id="stat-total">0</h4><small>×¡×”"×› × ×ª×¨×</small></div></div>
        <div class="col-6 col-md-3"><div class="card p-2 border-success"><h4 class="text-success m-0" id="stat-month">0</h4><small>×”×—×•×“×©</small></div></div>
        <div class="col-6 col-md-3"><div class="card p-2 border-warning"><h4 class="text-warning m-0" id="stat-users">0</h4><small>××©×ª××©×™×</small></div></div>
        <div class="col-6 col-md-3"><div class="card p-2 border-info"><h4 class="text-info m-0" id="stat-count">0</h4><small>×ª×¨×•××•×ª</small></div></div>
    </div>

    <div class="card">
        <div class="card-header"><input type="text" id="search" class="form-control" placeholder="×—×™×¤×•×©..." onkeyup="loadUsers()"></div>
        <div class="card-body p-0 table-responsive">
            <table class="table table-hover mb-0">
                <thead><tr><th>×©×</th><th>×¤×¨×˜×™×</th><th>×ª×¨×•××•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                <tbody id="users-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="pushModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">×©×œ×™×—×ª ×¤×•×©</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="text" id="push-title" class="form-control mb-2" placeholder="×›×•×ª×¨×ª">
                <textarea id="push-body" class="form-control" rows="3" placeholder="×ª×•×›×Ÿ ×”×”×•×“×¢×”"></textarea>
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-100" onclick="sendPush()">×©×œ×—</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">×¢×¨×™×›×”</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="mb-2"><label>×©×:</label><input type="text" id="edit-name" class="form-control"></div>
                <div class="mb-2"><label>×ª"×–:</label><input type="text" id="edit-tz" class="form-control"></div>
                <div class="mb-2"><label>×˜×œ×¤×•×Ÿ:</label><input type="text" id="edit-phone" class="form-control"></div>
                <div class="mb-2"><label>××™×™×œ:</label><input type="text" id="edit-email" class="form-control"></div>
                <div class="mb-2"><label class="text-danger fw-bold">Token (××©×¨××™):</label><input type="text" id="edit-token" class="form-control font-monospace"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-success w-100" onclick="saveUser()">×©××•×¨</button></div>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://pushcoins-server.onrender.com";

    window.onload = function() {
        Swal.fire({input:'password', title:'×¡×™×¡××”', allowOutsideClick:false}).then(res => {
            if(res.value === 'admin1234') {
                document.getElementById('admin-panel').classList.remove('d-none');
                loadStats(); loadUsers();
            } else location.reload();
        });
    };

    async function loadStats() {
        const res = await fetch(`${API_URL}/admin/stats`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password: 'admin1234'}) });
        const data = await res.json();
        if(data.success) {
            document.getElementById('stat-total').innerText = 'â‚ª' + data.stats.totalDonated.toLocaleString();
            document.getElementById('stat-month').innerText = 'â‚ª' + data.stats.monthlyDonated.toLocaleString();
            document.getElementById('stat-users').innerText = data.stats.totalUsers;
            document.getElementById('stat-count').innerText = data.stats.totalDonationsCount;
        }
    }

    async function loadUsers() {
        const query = document.getElementById('search').value;
        const res = await fetch(`${API_URL}/admin/get-users`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password: 'admin1234', searchQuery: query}) });
        const data = await res.json();
        const tbody = document.getElementById('users-body');
        tbody.innerHTML = '';
        data.users.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold">${u.name||'-'}</td>
                    <td><div class="small">${u.phone||''}</div><div class="small text-muted">${u.email||''}</div></td>
                    <td>â‚ª${u.totalDonated}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='editUser(${JSON.stringify(u)})'><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u._id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    function editUser(u) {
        document.getElementById('edit-id').value = u._id;
        document.getElementById('edit-name').value = u.name||'';
        document.getElementById('edit-tz').value = u.tz||'';
        document.getElementById('edit-phone').value = u.phone||'';
        document.getElementById('edit-email').value = u.email||'';
        document.getElementById('edit-token').value = u.token||'';
        new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }

    async function saveUser() {
        const userData = {
            name: document.getElementById('edit-name').value,
            tz: document.getElementById('edit-tz').value,
            phone: document.getElementById('edit-phone').value,
            email: document.getElementById('edit-email').value,
            token: document.getElementById('edit-token').value
        };
        await fetch(`${API_URL}/admin/update-user-full`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password: 'admin1234', userId: document.getElementById('edit-id').value, userData}) });
        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        loadUsers();
    }

    async function deleteUser(id) {
        if(confirm('×œ××—×•×§?')) {
            await fetch(`${API_URL}/admin/delete-user`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password: 'admin1234', userId: id}) });
            loadUsers();
        }
    }

    function openPushModal() { new bootstrap.Modal(document.getElementById('pushModal')).show(); }
    
    async function sendPush() {
        const title = document.getElementById('push-title').value;
        const body = document.getElementById('push-body').value;
        const res = await fetch(`${API_URL}/admin/send-push`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password: 'admin1234', title, body}) });
        const data = await res.json();
        bootstrap.Modal.getInstance(document.getElementById('pushModal')).hide();
        if(data.success) Swal.fire('× ×©×œ×—!', `×œ-${data.sentCount} ××›×©×™×¨×™×`, 'success');
        else Swal.fire('×©×’×™××”', data.error, 'error');
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
