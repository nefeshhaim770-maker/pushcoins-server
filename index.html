<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×§×•×¤×ª ×¦×“×§×” - × ×¤×© ×”×—×™×™×</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: linear-gradient(180deg, #e0f7fa 0%, #80deea 100%); font-family: 'Segoe UI', sans-serif; padding-bottom: 20px; margin: 0; height: 100vh; overflow: hidden; user-select: none; }
        .top-bar { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: absolute; top: 0; width: 100%; z-index: 100; }
        .icon-btn { background: white; border: none; width: 42px; height: 42px; border-radius: 50%; color: #006064; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        .badge-count { position: absolute; top: -3px; left: -3px; background: #ff5252; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; border: 2px solid white; font-weight: bold; }
        .coins-wrapper { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; padding: 20px 10px; max-width: 400px; margin: 0 auto; z-index: 10; position: relative; top: 80px; }
        .coin { width: 72px; height: 72px; background: radial-gradient(circle at 30% 30%, #fff, #ffca28); border-radius: 50%; border: 4px solid #fbc02d; box-shadow: 0 6px 10px rgba(0,0,0,0.15); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: transform 0.1s; }
        .coin:active { transform: scale(0.95); }
        .coin.silver { background: radial-gradient(circle at 30% 30%, #fff, #eeeeee); border-color: #bdbdbd; }
        .coin span { font-weight: 800; font-size: 1.5rem; line-height: 1; color: #424242; }
        .coin small { font-size: 0.7rem; color: #616161; font-weight: bold; }
        .flying-coin { position: fixed; z-index: 9999; pointer-events: none; transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .pushka-container { position: absolute; bottom: 0; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .pushka-slot { width: 120px; height: 12px; background: #37474f; border-radius: 10px; margin-bottom: -6px; z-index: 5; box-shadow: inset 0 2px 5px black; }
        .pushka-body { width: 100%; max-width: 500px; background: white; border-top-left-radius: 30px; border-top-right-radius: 30px; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); padding: 25px; text-align: center; display: flex; flex-direction: column; align-items: center; padding-bottom: 40px; }
        .logo-img { width: 80px; height: 80px; object-fit: contain; border-radius: 50%; margin-bottom: 10px; }
        .mode-indicator { background: #e0f2f1; color: #00695c; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-top: 10px; display: inline-block; }
        .note-input { width: 100%; border: 1px solid #e0e0e0; background: #f5f5f5; padding: 10px; border-radius: 12px; text-align: center; margin-bottom: 10px; outline: none; }
        .overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .card-modal { background: white; width: 90%; max-width: 360px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="top-bar">
    <button class="icon-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
    <div style="text-align: center;">
        <small style="color: #006064; font-weight: bold; display: block; line-height: 1;">×¡×”"×› ×–×›×•×™×•×ª</small>
        <span id="user-total" style="font-size: 1.2rem; font-weight: 800; color: #00838f;">â‚ª0</span>
    </div>
    <button class="icon-btn" onclick="openBasket()">
        <i class="fas fa-shopping-cart"></i>
        <span id="basket-badge" class="badge-count d-none">0</span>
    </button>
</div>

<div class="coins-wrapper">
    <div class="coin silver" onclick="clickCoin(1, this)"><span>1</span><small>â‚ª</small></div>
    <div class="coin silver" onclick="clickCoin(2, this)"><span>2</span><small>â‚ª</small></div>
    <div class="coin silver" onclick="clickCoin(5, this)"><span>5</span><small>â‚ª</small></div>
    <div class="coin" onclick="clickCoin(10, this)"><span>10</span><small>â‚ª</small></div>
    <div class="coin" onclick="clickCoin(18, this)"><span>18</span><small>×—"×™</small></div>
    <div class="coin" id="custom-coin" onclick="handleCustomCoin(this)"><i class="fas fa-pen"></i><small>××—×¨</small></div>
</div>

<div class="pushka-container">
    <div id="target-slot" class="pushka-slot"></div>
    <div class="pushka-body">
        <img src="logo.jpeg" class="logo-img">
        <h4 class="fw-bold" style="color: #006064;">× ×¤×© ×”×—×™×™×</h4>
        <input type="text" id="donation-note" class="note-input" placeholder="×”×•×¡×£ ×”×¢×¨×” / ×”×§×“×©×”">
        <div id="status-text" class="mode-indicator">××¦×‘: ×˜×•×¢×Ÿ...</div>
    </div>
</div>

<div id="login-screen" class="overlay bg-light" style="z-index: 5000;">
    <div class="text-center p-4" style="max-width: 350px;">
        <img src="logo.jpeg" width="90" class="mb-3 rounded-circle shadow">
        <h3 class="fw-bold text-dark mb-4">×‘×¨×•×›×™× ×”×‘××™×</h3>
        <input type="text" id="login-input" class="form-control text-center rounded-4 mb-3" placeholder="× ×™×™×“ / ××™×™×œ">
        <div id="otp-area" class="d-none mb-3"><input type="number" id="otp-input" class="form-control text-center rounded-4 fs-4" placeholder="×§×•×“"></div>
        <button onclick="sendCode()" id="btn-send" class="btn btn-dark w-100 py-3 rounded-pill fw-bold">×©×œ×— ×§×•×“</button>
        <button onclick="verifyCode()" id="btn-verify" class="btn btn-success w-100 py-3 rounded-pill fw-bold d-none">×›× ×™×¡×”</button>
    </div>
</div>

<div id="basket-modal" class="overlay d-none">
    <div class="card-modal">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0 fw-bold">ğŸ›’ ×¡×œ ×ª×¨×•××•×ª</h5>
            <button class="btn-close" onclick="toggle('basket-modal', false)"></button>
        </div>
        <div id="basket-content" style="max-height: 200px; overflow-y: auto;"></div>
        <div class="alert alert-secondary py-2 mt-3 text-center small mb-0">×—×™×•×‘ ×‘-<strong id="billing-date">--</strong> ×œ×—×•×“×©</div>
    </div>
</div>

<div id="settings-modal" class="overlay d-none">
    <div class="card-modal text-end">
        <h5 class="fw-bold mb-3 text-center">×”×’×“×¨×•×ª</h5>
        <label class="small fw-bold">××¤×©×¨×•×™×•×ª ×—×™×•×‘</label>
        <select id="set-date" class="form-select mb-2">
            <option value="0">×—×™×•×‘ ××™×™×“×™ (×œ×œ× ×¡×œ)</option>
            <option value="1">1 ×œ×—×•×“×©</option>
            <option value="10">10 ×œ×—×•×“×©</option>
            <option value="20">20 ×œ×—×•×“×©</option>
        </select>
        <label class="small fw-bold">×”×•×¨××ª ×§×‘×¢ ×™×•××™×ª (â‚ª)</label>
        <input type="number" id="set-daily" class="form-control mb-2" placeholder="0 (×œ× ×¤×¢×™×œ)">
        <label class="small fw-bold">×§×•×“ ××‘×˜×—×” (PIN)</label>
        <input type="password" id="set-pin" class="form-control mb-3" placeholder="×§×•×“ ×œ××™×©×•×¨ ×ª×¨×•××”" maxlength="4">
        <label class="small fw-bold">×¤×¨×˜×™× ××™×©×™×™×</label>
        <input id="set-name" class="form-control mb-1" placeholder="×©×">
        <input id="set-phone" class="form-control mb-1" placeholder="×˜×œ×¤×•×Ÿ">
        <input id="set-email" class="form-control mb-1" placeholder="××™×™×œ">
        <div class="d-flex justify-content-between border p-2 rounded align-items-center mt-3 bg-light">
            <small id="card-status">×˜×•×¢×Ÿ...</small>
            <button class="btn btn-sm btn-outline-danger" onclick="resetCard()">××—×§</button>
        </div>
        <button class="btn btn-primary w-100 rounded-pill mt-3" onclick="saveSettings()">×©××•×¨ ×©×™× ×•×™×™×</button>
        <button class="btn btn-link text-danger w-100 mt-1" onclick="logout()">×™×¦×™××”</button>
        <button class="btn btn-link text-secondary w-100" onclick="toggle('settings-modal', false)">×¡×’×•×¨</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<script>
    const API = "https://pushcoins-server.onrender.com";
    let userId = localStorage.getItem('userId');
    let user = null;
    let customAmountValue = 0;

    window.onload = () => { if(userId) loadUser(); else document.getElementById('login-screen').classList.remove('d-none'); };

    // --- 1. ××˜×‘×¢ ××—×¨ (×œ×•×’×™×§×” ×›×¤×•×œ×”: ×§×‘×™×¢×” -> ×ª×¨×•××”)
    async function handleCustomCoin(el) {
        if (customAmountValue > 0 && el.innerText.includes('â‚ª')) {
            clickCoin(customAmountValue, el);
            setTimeout(() => {
                customAmountValue = 0;
                el.innerHTML = '<i class="fas fa-pen"></i><small>××—×¨</small>';
            }, 1000);
        } else {
            const { value: amount } = await Swal.fire({ title: '×¡×›×•× ×œ×ª×¨×•××”', input: 'number', confirmButtonText: '××™×©×•×¨' });
            if (amount > 0) {
                customAmountValue = Number(amount);
                el.innerHTML = `<span>${amount}</span><small>â‚ª</small>`;
            }
        }
    }

    // --- 2. ×ª×”×œ×™×š ××˜×‘×¢: ×× ×™××¦×™×” -> ×¤×¢×•×œ×” ×œ×¤×™ ×”×’×“×¨×•×ª
    function clickCoin(amount, element) {
        const clone = element.cloneNode(true);
        const rect = element.getBoundingClientRect();
        const target = document.getElementById('target-slot').getBoundingClientRect();
        
        clone.className = 'coin flying-coin';
        if(element.classList.contains('silver')) clone.classList.add('silver');
        clone.style.left = rect.left+'px'; clone.style.top = rect.top+'px';
        document.body.appendChild(clone);
        
        setTimeout(() => { 
            clone.style.left = (target.left + target.width/2 - 36)+'px'; 
            clone.style.top = target.top+'px'; 
            clone.style.transform = 'scale(0.4)'; 
            clone.style.opacity = '0'; 
        }, 10);
        
        setTimeout(() => clone.remove(), 600);

        // ×©×•×œ×—×™× ×œ×©×¨×ª ×¢× forceImmediate = null (×”×©×¨×ª ×™×—×œ×™×˜ ×œ×¤×™ ×”×”×’×“×¨×•×ª)
        processDonation(amount, null);
    }

    async function processDonation(amount, forceImmediate) {
        let providedPin = "";
        if(user.securityPin && user.securityPin.trim() !== "") {
            const { value: pin } = await Swal.fire({
                title: 'ğŸ”’ ××‘×˜×—×”',
                text: '×”×§×© ×§×•×“ PIN ×œ××™×©×•×¨',
                input: 'password',
                inputAttributes: { maxlength: 4, inputmode: 'numeric' },
                showCancelButton: true
            });
            if(!pin) return;
            providedPin = pin;
        }

        const note = document.getElementById('donation-note').value;
        const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        
        fetch(API + '/donate', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ userId, amount, useToken: true, note, providedPin, forceImmediate })
        })
        .then(r => r.json()).then(d => {
            if(d.success) {
                toast.fire({ icon: 'success', title: d.message });
                document.getElementById('donation-note').value = '';
                loadUser();
            } else {
                Swal.fire('×©×’×™××”', d.error, 'error');
            }
        });
    }

    function loadUser() {
        fetch(API + '/login-by-id', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId})})
        .then(r=>r.json()).then(d=>{
            if(d.success) {
                user = d.user;
                document.getElementById('login-screen').classList.add('d-none');
                document.getElementById('user-total').innerText = 'â‚ª' + (user.totalDonated||0).toFixed(0);
                
                const count = user.pendingDonations?.length || 0;
                document.getElementById('basket-badge').innerText = count;
                document.getElementById('basket-badge').classList.toggle('d-none', count === 0);
                
                const modeText = user.billingPreference === 0 ? "×—×™×•×‘ ××™×™×“×™" : `×¦×‘×™×¨×” ×œ×¡×œ (${user.billingPreference} ×œ×—×•×“×©)`;
                document.getElementById('status-text').innerText = "××¦×‘: " + modeText;
                document.getElementById('billing-date').innerText = user.billingPreference === 0 ? "××™×™×“×™" : user.billingPreference;

                document.getElementById('set-name').value = user.name||'';
                document.getElementById('set-phone').value = user.phone||'';
                document.getElementById('set-email').value = user.email||'';
                document.getElementById('set-date').value = user.billingPreference||0;
                document.getElementById('set-daily').value = user.recurringDailyAmount||'';
                document.getElementById('set-pin').value = user.securityPin||'';
                document.getElementById('card-status').innerHTML = user.lastCardDigits ? `**** ${user.lastCardDigits}` : '××™×Ÿ ×›×¨×˜×™×¡';
            } else document.getElementById('login-screen').classList.remove('d-none');
        });
    }

    function openBasket() { 
        toggle('basket-modal', true);
        const list = document.getElementById('basket-content');
        list.innerHTML = '';
        if(!user.pendingDonations?.length) list.innerHTML = '<div class="text-center text-muted p-3">×”×¢×’×œ×” ×¨×™×§×”</div>';
        user.pendingDonations.forEach(item => {
            list.innerHTML += `<div class="list-item"><div><span class="fw-bold">â‚ª${item.amount}</span> <small>${item.note||''}</small></div><i class="fas fa-trash text-danger p-2" onclick="delPending('${item._id}')"></i></div>`;
        });
    }

    async function delPending(id) { 
        const res = await Swal.fire({title:'×œ××—×•×§?', icon:'question', showCancelButton:true, confirmButtonText:'×›×Ÿ', cancelButtonText:'×œ×'});
        if(res.isConfirmed) fetch(API + '/delete-pending', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId, donationId:id})}).then(() => { loadUser(); openBasket(); });
    }
    
    function saveSettings() {
        const data = {
            userId,
            name: document.getElementById('set-name').value,
            phone: document.getElementById('set-phone').value,
            email: document.getElementById('set-email').value,
            billingPreference: Number(document.getElementById('set-date').value),
            recurringDailyAmount: Number(document.getElementById('set-daily').value),
            securityPin: document.getElementById('set-pin').value
        };
        fetch(API+'/update-profile', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(() => { toggle('settings-modal', false); loadUser(); Swal.fire('× ×©××¨', '', 'success'); });
    }

    function toggle(id, show) { const el = document.getElementById(id); show ? el.classList.remove('d-none') : el.classList.add('d-none'); }
    function openSettings() { toggle('settings-modal', true); }
    function resetCard() { if(confirm('×œ××—×•×§ ×›×¨×˜×™×¡?')) fetch(API+'/reset-token', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId})}).then(()=>loadUser()); }
    function logout() { localStorage.removeItem('userId'); location.reload(); }
    function sendCode() { const val = document.getElementById('login-input').value; const code = Math.floor(1000+Math.random()*9000); fetch(API+'/update-code', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:val, code})}); document.getElementById('btn-send').classList.add('d-none'); document.getElementById('otp-area').classList.remove('d-none'); document.getElementById('btn-verify').classList.remove('d-none'); }
    function verifyCode() { const val = document.getElementById('login-input').value; const code = document.getElementById('otp-input').value; fetch(API+'/verify-auth', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:val, code})}).then(r=>r.json()).then(d=>{ if(d.success) { userId = d.user._id; localStorage.setItem('userId', userId); loadUser(); } else Swal.fire('×©×’×™××”', '×§×•×“ ×©×’×•×™', 'error'); }); }
</script>
</body>
</html>
