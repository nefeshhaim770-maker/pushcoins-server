<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×§×•×¤×ª ×¦×“×§×” - × ×¤×© ×”×—×™×™×</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { 
            background: linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%);
            font-family: 'Segoe UI', sans-serif; 
            padding-bottom: 80px; margin: 0; 
            overflow: hidden; height: 100vh; user-select: none;
        }

        /* ××˜×‘×¢×•×ª */
        .coins-container {
            display: flex; justify-content: center; gap: 12px; padding-top: 60px;
            flex-wrap: wrap; z-index: 10; position: relative; max-width: 400px; margin: 0 auto;
        }
        .coin {
            width: 75px; height: 75px;
            background: radial-gradient(circle at 30% 30%, #fff, #ffd700);
            border-radius: 50%; border: 4px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; z-index: 100; touch-action: none;
        }
        .coin.silver { background: radial-gradient(circle at 30% 30%, #fff, #e0e0e0); border-color: #a9a9a9; }
        .coin span { font-weight: bold; font-size: 1.4rem; line-height: 1; color: #444; pointer-events: none; }
        .coin small { font-size: 0.7rem; color: #666; pointer-events: none; }

        /* ×©×“×” ×”×¢×¨×” */
        .note-container {
            width: 80%; max-width: 300px; margin: 20px auto 0;
            position: relative; z-index: 5;
        }
        .note-input {
            width: 100%; background: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px; padding: 8px 15px; text-align: center; font-size: 1rem; color: #1e3c72;
            outline: none; transition: 0.3s;
        }
        .note-input:focus { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .note-input::placeholder { color: #555; opacity: 0.7; }

        /* ×§×•×¤×” */
        .pushka-box-container {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 280px; height: 300px; display: flex; flex-direction: column; align-items: center;
        }
        .slot-area {
            width: 140px; height: 15px; background: #2a2a2a; border-radius: 10px;
            margin-bottom: -5px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); z-index: 5;
        }
        .pushka-body {
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; padding-top: 20px; position: relative;
        }
        .pushka-logo {
            width: 100px; height: 100px; background: white; border-radius: 50%;
            padding: 5px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); object-fit: contain;
        }

        /* ×›×¤×ª×•×¨×™× ×¢×œ×™×•× ×™× */
        .header-icons {
            position: absolute; top: 15px; width: 100%; padding: 0 20px;
            display: flex; justify-content: space-between; z-index: 200;
        }
        .icon-btn { 
            background: rgba(255,255,255,0.8); border: none; width: 45px; height: 45px; border-radius: 50%; 
            color: #1e3c72; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 1.2rem; position: relative;
        }
        .badge-count { 
            position: absolute; top: -5px; left: -5px; background: #dc3545; color: white; 
            font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; border: 2px solid white; 
        }

        .dropping { transition: all 0.5s ease-in !important; transform: translateY(200px) scale(0.3) !important; opacity: 0 !important; }

        /* ××•×“×œ×™× */
        .overlay-screen { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-card { background: white; width: 90%; max-width: 350px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .input-lg { font-size: 2rem; text-align: center; border: none; border-bottom: 2px solid #ddd; width: 150px; margin: 20px auto; outline: none; }
    </style>
</head>
<body>

<div class="header-icons">
    <button class="icon-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
    <div class="bg-white px-3 py-2 rounded-pill shadow-sm text-primary fw-bold d-flex align-items-center" style="height: 45px;">
        <span id="total-display">â‚ª0</span>
    </div>
    <button class="icon-btn" onclick="openBasket()">
        <i class="fas fa-shopping-cart"></i>
        <span class="badge-count d-none" id="basket-badge">0</span>
    </button>
</div>

<div class="coins-container">
    <div class="coin silver" data-amount="1"><span>1</span><small>â‚ª</small></div>
    <div class="coin silver" data-amount="2"><span>2</span><small>â‚ª</small></div>
    <div class="coin silver" data-amount="5"><span>5</span><small>â‚ª</small></div>
    <div class="coin" data-amount="10"><span>10</span><small>â‚ª</small></div>
    <div class="coin" data-amount="18"><span>18</span><small>×—"×™</small></div>
    <div class="coin" onclick="openCustomAmount()"><i class="fas fa-pen"></i><small>××—×¨</small></div>
</div>

<div class="note-container">
    <input type="text" id="main-note" class="note-input" placeholder="×”×•×¡×£ ×”×¢×¨×” (×œ×–×›×•×ª/×œ×¢×™×œ×•×™ × ×©××ª...)">
</div>

<div class="pushka-box-container">
    <div class="slot-area" id="slot"></div>
    <div class="pushka-body">
        <img src="logo.jpeg" alt="Logo" class="pushka-logo"> 
        <h4 class="fw-bold mb-0">× ×¤×© ×”×—×™×™×</h4>
        <small class="opacity-75 mb-3">×’×¨×•×¨ ××˜×‘×¢ ×œ×§×•×¤×”</small>
        
        <div class="w-100 px-4 mt-auto mb-4">
            <button class="btn btn-light w-100 text-primary fw-bold shadow-sm rounded-pill" onclick="donateNowBtn()">
                <i class="fas fa-bolt me-2"></i> ×—×™×•×‘ ××™×™×“×™
            </button>
        </div>
    </div>
</div>

<div id="login-section" class="overlay-screen bg-white" style="z-index: 5000;">
    <div class="text-center p-4 w-100" style="max-width: 350px;">
        <img src="logo.jpeg" width="80" class="mb-3 rounded-circle shadow">
        <h2 class="fw-bold text-primary">×‘×¨×•×›×™× ×”×‘××™×</h2>
        <div class="form-floating mb-3 border rounded-4 mt-4">
            <input type="text" id="login-input" class="form-control border-0 bg-light text-center" placeholder="× ×™×™×“">
            <label class="w-100 text-center">××¡×¤×¨ ×˜×œ×¤×•×Ÿ ××• ××™××™×™×œ</label>
        </div>
        <div id="otp-area" class="d-none mb-3 border rounded-4">
            <input type="number" id="otp-input" class="form-control border-0 bg-light text-center fs-4" placeholder="×§×•×“">
        </div>
        <button onclick="sendCode()" id="btn-send-code" class="btn btn-primary w-100 btn-lg rounded-pill shadow">×©×œ×— ×§×•×“ ××™××•×ª</button>
        <button onclick="verifyCode()" id="btn-verify" class="btn btn-success w-100 btn-lg rounded-pill shadow d-none">×›× ×™×¡×”</button>
    </div>
</div>

<div id="customAmountModal" class="overlay-screen d-none">
    <div class="modal-card">
        <h5>×¡×›×•× ×œ×ª×¨×•××”</h5>
        <input type="number" id="custom-amount-input" class="input-lg" placeholder="â‚ª">
        <button class="btn btn-primary w-100 rounded-pill py-2 fw-bold" onclick="donateCustom()">×”×•×¡×£ ×œ×§×•×¤×”</button>
        <button class="btn btn-link text-muted mt-2" onclick="toggleModal('customAmountModal', false)">×‘×™×˜×•×œ</button>
    </div>
</div>

<div id="basketModal" class="overlay-screen d-none">
    <div class="modal-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0 fw-bold">ğŸ›’ ×¡×œ ×ª×¨×•××•×ª</h5>
            <button class="btn-close" onclick="toggleModal('basketModal', false)"></button>
        </div>
        <div id="basket-list" class="mb-3"></div>
        <div class="alert alert-info py-2 small text-center mb-0">
            ×—×™×•×‘ ×‘×™×•× ×”-<strong id="billing-day-display">--</strong> ×œ×—×•×“×©
        </div>
    </div>
</div>

<div id="settingsModal" class="overlay-screen d-none">
    <div class="modal-card text-end">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0 fw-bold">×”×’×“×¨×•×ª ×•×¤×¨×•×¤×™×œ</h5>
            <button class="btn-close" onclick="toggleModal('settingsModal', false)"></button>
        </div>
        
        <label class="small text-muted fw-bold">××•×¢×“ ×—×™×•×‘ ×”×¡×œ</label>
        <select id="edit-billing-day" class="form-select mb-3">
            <option value="0">××™×™×“×™ (×œ×œ× ×¡×œ)</option>
            <option value="1">1 ×œ×—×•×“×©</option>
            <option value="2">2 ×œ×—×•×“×©</option>
            <option value="10">10 ×œ×—×•×“×©</option>
            <option value="20">20 ×œ×—×•×“×©</option>
        </select>

        <label class="small text-muted fw-bold">×¤×¨×˜×™× ××™×©×™×™×</label>
        <input type="text" id="edit-name" class="form-control mb-2" placeholder="×©× ××œ×">
        <input type="text" id="edit-phone" class="form-control mb-2" placeholder="×˜×œ×¤×•×Ÿ">
        <input type="email" id="edit-email" class="form-control mb-2" placeholder="××™××™×™×œ">
        <input type="text" id="edit-tz" class="form-control mb-3" placeholder="×ª×¢×•×“×ª ×–×”×•×ª">
        
        <div class="d-flex justify-content-between border p-2 mb-3 rounded align-items-center bg-light">
            <small id="credit-info">×˜×•×¢×Ÿ...</small>
            <button class="btn btn-sm btn-outline-danger" onclick="resetCreditCard()">×”×—×œ×£</button>
        </div>

        <button class="btn btn-primary w-100 rounded-pill mb-2" onclick="saveSettings()">×©××•×¨ ×©×™× ×•×™×™×</button>
        <button class="btn btn-outline-danger w-100 rounded-pill" onclick="logout()">×™×¦×™××”</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<script>
    var API_URL = "https://pushcoins-server.onrender.com";
    var currentUserId = null, currentUser = null;
    var currentDrag = null;
    var startX, startY;

    // ××ª×—×•×œ
    window.onload = function() {
        initDrag();
        try { currentUserId = localStorage.getItem('userId'); if(currentUserId) loadUser(); } catch(e){}
    };

    function loadUser() {
        fetch(API_URL + '/login-by-id', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:currentUserId}) })
        .then(r=>r.json()).then(d=>{
            if(d.success) { 
                currentUser = d.user; 
                document.getElementById('login-section').classList.add('d-none');
                updateUI();
            } else document.getElementById('login-section').classList.remove('d-none');
        });
    }

    function updateUI() {
        document.getElementById('total-display').innerText = 'â‚ª' + (currentUser.totalDonated||0).toFixed(0);
        
        // ×¢×“×›×•×Ÿ ×‘××“×’' ×¡×œ
        var count = currentUser.pendingDonations ? currentUser.pendingDonations.length : 0;
        var badge = document.getElementById('basket-badge');
        badge.innerText = count;
        count > 0 ? badge.classList.remove('d-none') : badge.classList.add('d-none');

        // ×¢×“×›×•×Ÿ ×˜×•×¤×¡ ×”×’×“×¨×•×ª
        document.getElementById('edit-name').value = currentUser.name || "";
        document.getElementById('edit-phone').value = currentUser.phone || "";
        document.getElementById('edit-email').value = currentUser.email || "";
        document.getElementById('edit-tz').value = currentUser.tz || "";
        document.getElementById('edit-billing-day').value = currentUser.billingPreference || 0;
        document.getElementById('billing-day-display').innerText = currentUser.billingPreference || "××™×™×“×™";
        document.getElementById('credit-info').innerHTML = currentUser.lastCardDigits ? "<span class='text-success fw-bold'>**** " + currentUser.lastCardDigits + "</span>" : "××™×Ÿ ×›×¨×˜×™×¡";
    }

    // --- ×’×¨×™×¨×” ---
    function initDrag() {
        const coins = document.querySelectorAll('.coin[data-amount]');
        coins.forEach(coin => {
            coin.addEventListener('touchstart', dragStart, {passive: false});
            coin.addEventListener('touchmove', dragMove, {passive: false});
            coin.addEventListener('touchend', dragEnd);
            coin.addEventListener('mousedown', dragStart);
        });
    }

    function dragStart(e) {
        if(e.target.tagName === 'I' || e.target.closest('div').onclick) return;
        e.preventDefault();
        currentDrag = e.currentTarget;
        const touch = e.touches ? e.touches[0] : e;
        const rect = currentDrag.getBoundingClientRect();
        startX = touch.clientX - rect.left;
        startY = touch.clientY - rect.top;
        currentDrag.style.position = 'fixed';
        currentDrag.style.zIndex = 1000;
        moveAt(touch.clientX, touch.clientY);
    }

    function dragMove(e) {
        if(!currentDrag) return;
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        moveAt(touch.clientX, touch.clientY);
    }

    function dragEnd(e) {
        if(!currentDrag) return;
        const rect = currentDrag.getBoundingClientRect();
        const slot = document.getElementById('slot').getBoundingClientRect();

        if (rect.top + rect.height > slot.top && rect.left + rect.width > slot.left && rect.left < slot.left + slot.width) {
            dropCoin(currentDrag);
        } else {
            currentDrag.style.position = 'relative';
            currentDrag.style.left = 'auto';
            currentDrag.style.top = 'auto';
        }
        
        document.removeEventListener('mousemove', dragMove);
        document.removeEventListener('mouseup', dragEnd);
        currentDrag = null;
    }

    document.addEventListener('mouseup', dragEnd);
    document.addEventListener('mousemove', dragMove);

    function moveAt(x, y) {
        currentDrag.style.left = x - startX + 'px';
        currentDrag.style.top = y - startY + 'px';
    }

    function dropCoin(coin) {
        const amt = coin.getAttribute('data-amount');
        coin.classList.add('dropping');
        setTimeout(() => {
            coin.classList.remove('dropping');
            coin.style.position = 'relative'; coin.style.left = 'auto'; coin.style.top = 'auto';
            processDonation(amt, false); // false = ×œ× ×œ×›×¤×•×ª ××™×™×“×™ (×ª×œ×•×™ ×‘×”×’×“×¨×•×ª)
        }, 500);
    }

    // --- ×ª×¨×•××•×ª ---
    function openCustomAmount() { toggleModal('customAmountModal', true); }
    function donateCustom() {
        const val = document.getElementById('custom-amount-input').value;
        if(val > 0) { toggleModal('customAmountModal', false); processDonation(val, false); }
    }
    function donateNowBtn() {
        // ×›×¤×ª×•×¨ ×—×™×•×‘ ××™×™×“×™ - ×¤×•×ª×— ××•×“×œ ×¡×›×•× ×× ×œ× × ×‘×—×¨, ××• ××‘×§×© ×¡×›×•×
        Swal.fire({
            title: '×—×™×•×‘ ××™×™×“×™',
            text: '×”×›× ×¡ ×¡×›×•× ×œ×ª×¨×•××”',
            input: 'number',
            showCancelButton: true,
            confirmButtonText: '×—×™×™×‘ ×¢×›×©×™×•'
        }).then((result) => {
            if (result.isConfirmed && result.value > 0) {
                processDonation(result.value, true); // true = ×›×¤×™×™×ª ××™×™×“×™
            }
        });
    }

    function processDonation(amount, forceImmediate) {
        const note = document.getElementById('main-note').value;
        
        // ×× ×œ××©×ª××© ××™×Ÿ ×˜×•×§×Ÿ ×•×”×•× ×× ×¡×” ×œ×ª×¨×•× - ×”×•× ×™×™×›× ×¡ ×œ×¡×œ ×‘×›×œ ××§×¨×”, ××œ× ×× ×–×” ××™×™×“×™ ×•××– ×¦×¨×™×š ××©×¨××™
        if(!currentUser.token && forceImmediate) {
            return Swal.fire('×©×’×™××”', '××™×Ÿ ×›×¨×˜×™×¡ ××©×¨××™ ×©××•×¨. × × ×œ×”×•×¡×™×£ ×œ×¡×œ.', 'error');
        }

        Swal.fire({title: '××¢×‘×“...', didOpen: () => Swal.showLoading()});
        
        fetch(API_URL + '/donate', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                userId: currentUserId,
                amount: amount,
                useToken: true,
                note: note,
                forceImmediate: forceImmediate
            })
        })
        .then(r => r.json())
        .then(data => {
            Swal.close();
            if(data.success) {
                Swal.fire({title: data.message, icon: 'success', timer: 1500, showConfirmButton: false});
                document.getElementById('main-note').value = ''; // × ×™×§×•×™ ×”×¢×¨×”
                loadUser();
            } else {
                Swal.fire('×©×’×™××”', data.error, 'error');
            }
        });
    }

    // --- ××•×“×œ×™× ×•× ×™×”×•×œ ---
    function toggleModal(id, show) {
        const el = document.getElementById(id);
        show ? el.classList.remove('d-none') : el.classList.add('d-none');
    }
    function openSettings() { toggleModal('settingsModal', true); }
    function openBasket() { 
        toggleModal('basketModal', true);
        renderBasket();
    }

    function renderBasket() {
        const list = document.getElementById('basket-list');
        list.innerHTML = '';
        if(!currentUser.pendingDonations?.length) { list.innerHTML = '<div class="text-center text-muted">×”×¡×œ ×¨×™×§</div>'; return; }
        currentUser.pendingDonations.forEach(item => {
            list.innerHTML += `
                <div class="d-flex justify-content-between border-bottom py-2 align-items-center">
                    <div><b>â‚ª${item.amount}</b> <small class="text-muted">${item.note||''}</small></div>
                    <button class="btn btn-sm text-danger" onclick="delPending('${item._id}')"><i class="fas fa-trash"></i></button>
                </div>`;
        });
    }

    function delPending(id) {
        fetch(API_URL + '/delete-pending', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: currentUserId, donationId: id }) })
        .then(() => loadUser()).then(() => renderBasket()); // ×¨×¢× ×•×Ÿ
    }

    function saveSettings() {
        const data = {
            userId: currentUserId,
            name: document.getElementById('edit-name').value,
            phone: document.getElementById('edit-phone').value,
            email: document.getElementById('edit-email').value,
            tz: document.getElementById('edit-tz').value,
            billingPreference: document.getElementById('edit-billing-day').value
        };
        Swal.fire({title:'×©×•××¨...', didOpen:()=>Swal.showLoading()});
        fetch(API_URL + '/update-profile', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) })
        .then(() => { Swal.close(); toggleModal('settingsModal', false); loadUser(); });
    }

    function resetCreditCard() {
        if(confirm('×œ××—×•×§ ×›×¨×˜×™×¡?')) {
            fetch(API_URL + '/reset-token', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: currentUserId }) })
            .then(() => loadUser());
        }
    }

    function logout() { localStorage.removeItem('userId'); location.reload(); }

    // --- ×œ×•×’×™×Ÿ ---
    function sendCode() {
        const val = document.getElementById('login-input').value;
        if(!val) return;
        const code = Math.floor(1000+Math.random()*9000);
        fetch(API_URL+'/update-code', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:val, code:code})});
        document.getElementById('btn-send-code').classList.add('d-none');
        document.getElementById('otp-area').classList.remove('d-none');
        document.getElementById('btn-verify').classList.remove('d-none');
    }
    
    function verifyCode() {
        const val = document.getElementById('login-input').value;
        const code = document.getElementById('otp-input').value;
        fetch(API_URL+'/verify-auth', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:val, code:code})})
        .then(r=>r.json()).then(d=>{
            if(d.success) { currentUserId = d.user._id; localStorage.setItem('userId', currentUserId); loadUser(); } 
            else alert('×§×•×“ ×©×’×•×™');
        });
    }
</script>
</body>
</html>
