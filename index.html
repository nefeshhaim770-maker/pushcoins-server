<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>× ×¤×© ×”×—×™×™×</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .swal2-container { z-index: 20000 !important; }

        body { 
            background: linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%);
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        .main-content-wrapper {
            flex: 1; display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            padding-top: 80px; padding-bottom: 20px; overflow-y: auto;
        }

        #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        .loader-logo { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 20px; animation: pulse 1.5s infinite; box-shadow: 0 5px 15px rgba(0,0,0,0.1); object-fit: contain; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1e3c72; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .fade-out { opacity: 0; pointer-events: none; }

        .header-icons {
            position: absolute; top: 15px; width: 100%; padding: 0 20px;
            display: flex; justify-content: space-between; z-index: 200;
        }
        .icon-btn { 
            background: rgba(255,255,255,0.9); border: none; width: 45px; height: 45px; border-radius: 50%; 
            color: #1e3c72; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 1.2rem; position: relative;
        }
        .badge-count { 
            position: absolute; top: -5px; left: -5px; background: #dc3545; color: white; 
            font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; border: 2px solid white; 
        }

        .coins-container {
            display: flex; justify-content: center; gap: 12px;
            flex-wrap: wrap; z-index: 10; position: relative; max-width: 400px;
            flex-shrink: 0; margin-bottom: 20px;
        }
        .coin {
            width: 75px; height: 75px;
            background: radial-gradient(circle at 30% 30%, #fff, #ffd700);
            border-radius: 50%; border: 4px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; z-index: 100; transition: transform 0.1s;
        }
        .coin:active { transform: scale(0.95); }
        .coin.silver { background: radial-gradient(circle at 30% 30%, #fff, #e0e0e0); border-color: #a9a9a9; }
        .coin span { font-weight: bold; font-size: 1.4rem; line-height: 1; color: #444; pointer-events: none; }
        .coin small { font-size: 0.7rem; color: #666; pointer-events: none; }
        .flying-coin { position: fixed; z-index: 9999; pointer-events: none; transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        .pushka-box-container {
            position: relative; width: 290px; height: 340px;
            display: flex; flex-direction: column; align-items: center; flex-shrink: 0;
        }
        .slot-area {
            width: 140px; height: 15px; background: #2a2a2a;
            border-radius: 10px; margin-bottom: -5px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); z-index: 5;
        }
        .pushka-body {
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center;
            color: white; padding-top: 15px; position: relative;
        }
        .pushka-logo {
            width: 80px; height: 80px; background: white; border-radius: 50%;
            padding: 5px; margin-bottom: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); object-fit: contain;
        }

        .digital-screen {
            background: #222; color: #00e676; font-family: 'Courier New', monospace;
            padding: 5px 15px; border-radius: 5px; font-size: 1.8rem; font-weight: bold;
            border: 3px solid #444; margin-bottom: 10px; min-width: 140px; text-align: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8); text-shadow: 0 0 5px rgba(0,230,118,0.5);
        }

        .actions-block { width: 100%; padding: 0 20px; display: flex; gap: 10px; margin-top: auto; margin-bottom: 15px; }
        .btn-game { flex: 1; padding: 12px; border: none; border-radius: 25px; font-weight: bold; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-basket { background: #fbc02d; color: #333; }
        .btn-pay { background: #00c853; }
        .btn-game:active { transform: scale(0.95); opacity: 0.9; }

        .note-input {
            width: 85%; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px; padding: 8px; text-align: center; font-size: 0.9rem; color: white;
            outline: none; margin-bottom: 10px;
        }
        .note-input::placeholder { color: rgba(255,255,255,0.7); }

        .overlay-screen { 
            position: fixed; top:0; left:0; right:0; bottom:0; 
            background: rgba(0,0,0,0.7); z-index: 5000; 
            display: flex; align-items: flex-start; justify-content: center; 
            overflow-y: auto; visibility: hidden; opacity: 0; transition: 0.3s; 
            padding: 20px 0;
        }
        .overlay-screen.open { visibility: visible; opacity: 1; }
        
        .modal-card { 
            background: white; width: 90%; max-width: 400px; 
            border-radius: 25px; padding: 25px; text-align: center; 
            margin: 20px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }
        .list-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; align-items: center; }
        .required-label::after { content: "*"; color: red; margin-right: 4px; }
    </style>
</head>
<body>

<div id="app-loader">
    <img src="https://www.nefesh-ha-chaim.org/icons/logo.png" class="loader-logo" alt="×˜×•×¢×Ÿ...">
    <div class="spinner"></div>
    <div style="margin-top: 10px; color: #555; font-weight: bold;">×˜×•×¢×Ÿ ××ª ×”×§×•×¤×”...</div>
</div>

<div class="header-icons">
    <button class="icon-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
    <div class="bg-white px-3 py-2 rounded-pill shadow-sm text-primary fw-bold d-flex align-items-center">
        <span id="user-total">â‚ª0</span>
    </div>
    <button class="icon-btn" onclick="openBasket()">
        <i class="fas fa-shopping-cart"></i>
        <span class="badge-count d-none" id="basket-badge">0</span>
    </button>
</div>

<div class="main-content-wrapper">
    <div class="coins-container">
        <div class="coin silver" onclick="clickCoin(1, this)"><span>1</span><small>â‚ª</small></div>
        <div class="coin silver" onclick="clickCoin(2, this)"><span>2</span><small>â‚ª</small></div>
        <div class="coin silver" onclick="clickCoin(5, this)"><span>5</span><small>â‚ª</small></div>
        <div class="coin" onclick="clickCoin(10, this)"><span>10</span><small>â‚ª</small></div>
        <div class="coin" onclick="clickCoin(18, this)"><span>18</span><small>×—"×™</small></div>
        <div class="coin" id="custom-coin" onclick="handleCustomCoin(this)"><i class="fas fa-pen"></i><small>××—×¨</small></div>
    </div>

    <div class="pushka-box-container">
        <div class="slot-area" id="target-slot"></div>
        <div class="pushka-body">
            <img src="https://www.nefesh-ha-chaim.org/icons/logo.png" alt="Logo" class="pushka-logo"> 
            <div id="screen" class="digital-screen">â‚ª0</div>
            <input type="text" id="donation-note" class="note-input" placeholder="×”×•×¡×£ ×”×¢×¨×” / ×”×§×“×©×”">
            <div class="actions-block">
                <button class="btn-game btn-basket" onclick="submit(false)">×”×•×¡×£ ×œ×¡×œ</button>
                <button class="btn-game btn-pay" onclick="submit(true)">×ª×¨×•×</button>
            </div>
            <small id="status-text" style="color: rgba(255,255,255,0.7); font-size: 0.75rem;">××¦×‘: ×˜×•×¢×Ÿ...</small>
        </div>
    </div>
</div>

<div id="login-modal" class="overlay-screen" style="z-index: 9000;">
    <div class="modal-card">
        <img src="https://www.nefesh-ha-chaim.org/icons/logo.png" width="80" class="mb-3 rounded-circle shadow">
        <h3 class="fw-bold text-primary">×‘×¨×•×›×™× ×”×‘××™×</h3>
        <div class="form-floating mb-3 border rounded-4 mt-4">
            <input type="tel" id="login-val" class="form-control border-0 bg-light text-center" placeholder="×¤×¨×˜×™×">
            <label class="w-100 text-center">× ×™×™×“ ××• ××™××™×™×œ</label>
        </div>
        <div id="otp-area" class="d-none mb-3 border rounded-4">
            <input type="number" id="otp-val" class="form-control border-0 bg-light text-center fs-4" placeholder="×§×•×“">
        </div>
        <button onclick="sendCode()" id="btn-send" class="btn btn-primary w-100 btn-lg rounded-pill shadow">×©×œ×— ×§×•×“</button>
        <button onclick="verifyCode()" id="btn-verify" class="btn btn-success w-100 btn-lg rounded-pill shadow d-none">×›× ×™×¡×”</button>
    </div>
</div>

<div id="basket-modal" class="overlay-screen">
    <div class="modal-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0 fw-bold">ğŸ›’ ×”×¢×’×œ×” ×©×œ×™</h5>
            <button class="btn-close" onclick="closeModal('basket-modal')"></button>
        </div>
        <div class="alert alert-info py-2 small fw-bold" id="basket-summary-text">×˜×•×¢×Ÿ...</div>
        <div id="basket-list" class="mb-3 text-start"></div>
        <div class="text-muted small bg-light p-2 rounded">
            ×—×™×•×‘ ××¨×•×›×– ×™×ª×‘×¦×¢ ×‘-<span id="basket-date" class="fw-bold">--</span> ×œ×—×•×“×©<br>
            <span style="font-size: 0.8em; color: #666;">(×‘×©×¢×” 08:00 ×‘×‘×•×§×¨)</span>
        </div>
    </div>
</div>

<div id="history-modal" class="overlay-screen">
    <div class="modal-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0 fw-bold">ğŸ“œ ×”×™×¡×˜×•×¨×™×”</h5>
            <button class="btn-close" onclick="closeModal('history-modal')"></button>
        </div>
        <div class="modal-body p-0" style="max-height: 60vh; overflow-y: auto;">
            <table class="table table-striped mb-0 text-center small">
                <thead class="table-dark table-sm sticky-top">
                    <tr><th>×ª××¨×™×š</th><th>×¡×›×•×</th><th>×”×¢×¨×”</th><th>×¡×˜×˜×•×¡</th></tr>
                </thead>
                <tbody id="history-list"></tbody>
            </table>
        </div>
        <div id="no-history" class="text-center text-muted py-3 d-none">××™×Ÿ ×ª×¨×•××•×ª ×¢×“×™×™×Ÿ</div>
    </div>
</div>

<div id="settings-modal" class="overlay-screen">
    <div class="modal-card text-end">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0 fw-bold">×”×’×“×¨×•×ª</h5>
            <button class="btn-close" onclick="closeModal('settings-modal')"></button>
        </div>
        
        <label class="small fw-bold text-primary required-label">×¤×¨×˜×™× ××™×©×™×™×</label>
        <input id="set-name" class="form-control mb-1" placeholder="×©× ××œ×">
        <input id="set-phone" class="form-control mb-1" placeholder="×˜×œ×¤×•×Ÿ" type="tel">
        <input id="set-email" class="form-control mb-1" placeholder="××™××™×™×œ" type="email">
        <input id="set-tz" class="form-control mb-3" placeholder="×ª×¢×•×“×ª ×–×”×•×ª" type="tel">

        <hr>

        <label class="small fw-bold text-primary">×××¦×¢×™ ×ª×©×œ×•×</label>
        <div id="cc-saved-area" class="d-none justify-content-between border p-2 mb-3 rounded align-items-center bg-light">
            <small id="card-digits" class="fw-bold text-success">****</small>
            <button class="btn btn-sm btn-outline-danger" onclick="resetCard()">××—×§</button>
        </div>
        <div id="cc-input-area">
            <div class="alert alert-danger p-1 small mb-2" style="font-size: 0.75rem;">
                <i class="fas fa-info-circle"></i> ×œ×¦×•×¨×š ×©××™×¨×ª ×”×›×¨×˜×™×¡ ×™×ª×‘×¦×¢ ×—×™×•×‘ ×—×“-×¤×¢××™ ×©×œ 0.10 â‚ª
            </div>
            <input id="set-cc-num" class="form-control mb-1" placeholder="××¡×¤×¨ ×›×¨×˜×™×¡ ××©×¨××™" maxlength="16" type="tel">
            <div class="d-flex gap-2 mb-3">
                <input id="set-cc-exp" class="form-control" placeholder="×ª×•×§×£ (MMYY)" maxlength="4" type="tel">
                <input id="set-cc-cvv" class="form-control" placeholder="CVV (3 ×¡×¤')" maxlength="3" type="tel">
            </div>
        </div>

        <label class="small fw-bold text-primary">×™×•× ×—×™×•×‘ ×”×¡×œ</label>
        <div class="input-group mb-1">
            <select id="billing-type" class="form-select text-center" onchange="toggleBillingInput()">
                <option value="immediate">××™×™×“×™ (×œ×œ× ×¡×œ)</option>
                <option value="monthly">×™×•× ×‘×—×•×“×©</option>
            </select>
            <input type="tel" id="set-billing-day" class="form-control text-center d-none" placeholder="×™×•× (1-31)" min="1" max="31" oninput="validateDay(this)">
        </div>
        <div class="text-muted small mb-3 fst-italic" style="font-size: 0.75rem;">* ×”×—×™×•×‘ ××ª×‘×¦×¢ ×‘×©×¢×” 08:00 ×‘×‘×•×§×¨</div>

        <label class="small fw-bold text-primary">×”×•×¨××ª ×§×‘×¢ ×™×•××™×ª (â‚ª)</label>
        <input type="tel" id="set-daily" class="form-control mb-1" placeholder="0">
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="set-daily-immediate">
            <label class="form-check-label small" for="set-daily-immediate">×—×™×™×‘ ××©×¨××™ ××™×“×™×ª (×•×œ× ×œ×¡×œ)</label>
        </div>

        <label class="small fw-bold text-primary">×§×•×“ ××‘×˜×—×” (PIN)</label>
        <input type="password" id="set-pin" class="form-control mb-3" placeholder="4 ×¡×¤×¨×•×ª" maxlength="4">

        <button class="btn btn-outline-primary w-100 rounded-pill mb-2" onclick="openHistory()">ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ×ª×¨×•××•×ª</button>
        <button class="btn btn-primary w-100 rounded-pill mb-2" onclick="saveSettings()">×©××•×¨ ×©×™× ×•×™×™×</button>
        <button class="btn btn-outline-danger w-100 rounded-pill" onclick="logout()">×™×¦×™××”</button>
    </div>
</div>

<script>
    const API = "https://pushcoins-server.onrender.com";
    let userId = localStorage.getItem('userId');
    let user = null;
    let tempSum = 0;
    let customAmountValue = 0;

    window.onload = function() {
        if(userId) loadUser(userId);
        else {
            document.getElementById('app-loader').classList.add('fade-out');
            document.getElementById('login-modal').classList.add('open');
        }
    };

    function toggleBillingInput() {
        const type = document.getElementById('billing-type').value;
        const input = document.getElementById('set-billing-day');
        if (type === 'monthly') {
            input.classList.remove('d-none');
            if(!input.value || input.value == 0) input.value = 1;
        } else {
            input.classList.add('d-none');
            input.value = 0;
        }
    }

    function validateDay(el) {
        if(el.value > 31) el.value = 31;
        if(el.value < 1 && el.value !== "") el.value = 1;
        el.value = el.value.replace(/[^0-9]/g, '');
    }

    async function handleCustomCoin(el) {
        if (customAmountValue > 0 && el.innerText.includes('â‚ª')) {
            clickCoin(customAmountValue, el);
            setTimeout(() => {
                customAmountValue = 0;
                el.innerHTML = '<i class="fas fa-pen"></i><small>××—×¨</small>';
            }, 1000);
        } else {
            const { value: amount } = await Swal.fire({ title: '×¡×›×•× ×œ×ª×¨×•××”', input: 'number', confirmButtonText: '××™×©×•×¨' });
            if (amount > 0) {
                customAmountValue = Number(amount);
                el.innerHTML = `<span>${amount}</span><small>â‚ª</small>`;
            }
        }
    }

    function clickCoin(amount, element) {
        tempSum += amount;
        updateScreen();
        const clone = element.cloneNode(true);
        const rect = element.getBoundingClientRect();
        const target = document.getElementById('target-slot').getBoundingClientRect();
        clone.className = 'coin flying-coin';
        if(element.classList.contains('silver')) clone.classList.add('silver');
        clone.style.width = rect.width + 'px';
        clone.style.height = rect.height + 'px';
        clone.style.left = rect.left + 'px';
        clone.style.top = rect.top + 'px';
        document.body.appendChild(clone);
        setTimeout(() => {
            clone.style.left = (target.left + target.width/2 - 37) + 'px';
            clone.style.top = (target.top - 10) + 'px';
            clone.style.transform = 'scale(0.3)';
            clone.style.opacity = '0';
        }, 10);
        setTimeout(() => clone.remove(), 600);
    }

    function updateScreen() {
        const screen = document.getElementById('screen');
        screen.innerText = 'â‚ª' + tempSum;
        screen.style.color = '#fff';
        setTimeout(() => screen.style.color = '#00e676', 150);
    }

    async function submit(forceImmediate) {
        if(tempSum === 0) return Swal.fire('×”×§×•×¤×” ×¨×™×§×”', '×œ×—×¥ ×¢×œ ×”××˜×‘×¢×•×ª', 'info');
        
        let pin = "";
        if(user.securityPin) {
            const res = await Swal.fire({title: '×§×•×“ ××‘×˜×—×”', input: 'password', inputAttributes:{maxlength:4, inputmode:'numeric'}, showCancelButton: true});
            if(!res.isConfirmed) return;
            pin = res.value;
        }
        if(forceImmediate && !user.token) {
            Swal.fire({icon: 'warning', title: '×—×¡×¨ ××©×¨××™', text: '× × ×œ×”×•×¡×™×£ ×›×¨×˜×™×¡ ××©×¨××™ ×‘×”×’×“×¨×•×ª'});
            openSettings();
            return;
        }
        
        Swal.fire({title: '××¢×‘×“...', didOpen: () => Swal.showLoading()});
        const note = document.getElementById('donation-note').value;
        try {
            const res = await fetch(`${API}/donate`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId: user._id, amount: tempSum, note, forceImmediate, providedPin: pin, useToken: true })
            });
            const d = await res.json();
            if(d.success) {
                Swal.fire({icon: 'success', title: d.message, timer: 1500, showConfirmButton: false});
                tempSum = 0;
                updateScreen();
                document.getElementById('donation-note').value = '';
                loadUser(user._id);
            } else { Swal.fire('×©×’×™××”', d.error, 'error'); }
        } catch(e) { Swal.fire('×ª×§×œ×”', '×‘×¢×™×™×ª ×ª×§×©×•×¨×ª', 'error'); }
    }

    async function loadUser(id) {
        return fetch(`${API}/login-by-id`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id})})
        .then(r=>r.json()).then(d => {
            document.getElementById('app-loader').classList.add('fade-out');
            if(d.success) {
                user = d.user;
                localStorage.setItem('userId', user._id);
                document.getElementById('login-modal').classList.remove('open');
                
                document.getElementById('user-total').innerText = 'â‚ª' + (user.totalDonated||0).toLocaleString();
                const basketCount = user.pendingDonations?.length || 0;
                const badge = document.getElementById('basket-badge');
                badge.innerText = basketCount;
                badge.classList.toggle('d-none', basketCount === 0);
                
                const isImmediate = user.billingPreference === 0;
                document.getElementById('status-text').innerText = isImmediate ? "××¦×‘: ×—×™×•×‘ ××™×™×“×™" : `××¦×‘: ×¦×‘×™×¨×” ×œ-${user.billingPreference} ×‘×—×•×“×©`;
                document.getElementById('basket-date').innerText = isImmediate ? "××™×™×“×™" : user.billingPreference;

                document.getElementById('set-name').value = user.name||'';
                document.getElementById('set-phone').value = user.phone||'';
                document.getElementById('set-email').value = user.email||'';
                document.getElementById('set-tz').value = user.tz||'';
                
                if (user.billingPreference > 0) {
                    document.getElementById('billing-type').value = 'monthly';
                    document.getElementById('set-billing-day').value = user.billingPreference;
                    document.getElementById('set-billing-day').classList.remove('d-none');
                } else {
                    document.getElementById('billing-type').value = 'immediate';
                    document.getElementById('set-billing-day').classList.add('d-none');
                }

                document.getElementById('set-daily').value = user.recurringDailyAmount||'';
                document.getElementById('set-daily-immediate').checked = user.recurringImmediate === true;
                
                document.getElementById('set-pin').value = user.securityPin||'';
                
                if (user.token) {
                    document.getElementById('cc-saved-area').classList.remove('d-none');
                    document.getElementById('cc-saved-area').classList.add('d-flex');
                    document.getElementById('cc-input-area').classList.add('d-none');
                    document.getElementById('card-digits').innerText = '×›×¨×˜×™×¡ ×©××•×¨ (' + (user.lastCardDigits || '****') + ')';
                } else {
                    document.getElementById('cc-saved-area').classList.add('d-none');
                    document.getElementById('cc-saved-area').classList.remove('d-flex');
                    document.getElementById('cc-input-area').classList.remove('d-none');
                }

            } else { document.getElementById('login-modal').classList.add('open'); }
        });
    }

    function openHistory() {
        closeModal('settings-modal');
        const list = document.getElementById('history-list');
        const noHistory = document.getElementById('no-history');
        list.innerHTML = '';
        if (!user.donationsHistory || user.donationsHistory.length === 0) {
            noHistory.classList.remove('d-none');
        } else {
            noHistory.classList.add('d-none');
            [...user.donationsHistory].reverse().forEach(item => {
                const date = new Date(item.date).toLocaleDateString('he-IL');
                let statusBadge = item.status === 'success' ? '<span class="badge bg-success">×‘×•×¦×¢</span>' : '<span class="badge bg-danger">× ×›×©×œ</span>';
                list.innerHTML += `<tr><td>${date}</td><td class="fw-bold">â‚ª${item.amount}</td><td class="small text-muted">${item.note||'-'}</td><td>${statusBadge}</td></tr>`;
            });
        }
        document.getElementById('history-modal').classList.add('open');
    }

    function saveSettings() {
        // ×•×•×œ×™×“×¦×™×” ×¤×©×•×˜×” (×©×“×•×ª ×—×•×‘×”)
        const name = document.getElementById('set-name').value;
        const phone = document.getElementById('set-phone').value;
        const email = document.getElementById('set-email').value;
        const tz = document.getElementById('set-tz').value;

        if (!name || !phone || !email || !tz) {
            Swal.fire({icon: 'error', title: '×—×¡×¨×™× ×¤×¨×˜×™×', text: '× × ×œ××œ× ××ª ×›×œ ×”×¤×¨×˜×™× ×”××™×©×™×™×'});
            return;
        }

        let billingPref = 0;
        if (document.getElementById('billing-type').value === 'monthly') {
            billingPref = document.getElementById('set-billing-day').value || 1;
        }

        let newCardDetails = null;
        // × ×™×§×•×™ ×§×œ×˜ ×§×¨×™×˜×™
        const ccNum = document.getElementById('set-cc-num').value.replace(/\D/g, '');
        const ccExp = document.getElementById('set-cc-exp').value.replace(/\D/g, '');
        const ccCvv = document.getElementById('set-cc-cvv').value.replace(/\D/g, '');
        
        if (ccNum && ccExp && ccCvv) {
            if(ccExp.length !== 4) {
                Swal.fire('×©×’×™××”', '×ª×•×§×£ ×œ× ×ª×§×™×Ÿ (×¦×¨×™×š ×œ×”×™×•×ª 4 ×¡×¤×¨×•×ª)', 'error');
                return;
            }
            newCardDetails = { num: ccNum, exp: ccExp, cvv: ccCvv };
        }

        const data = {
            userId: user._id, name, phone, email, tz,
            billingPreference: Number(billingPref),
            recurringDailyAmount: Number(document.getElementById('set-daily').value),
            recurringImmediate: document.getElementById('set-daily-immediate').checked,
            securityPin: document.getElementById('set-pin').value,
            newCardDetails
        };

        Swal.fire({title:'×©×•××¨...', didOpen:()=>Swal.showLoading()});
        
        fetch(`${API}/admin/update-profile`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(r=>r.json()).then(d => {
            if(d.success) {
                closeModal('settings-modal');
                document.getElementById('set-cc-num').value = '';
                document.getElementById('set-cc-exp').value = '';
                document.getElementById('set-cc-cvv').value = '';
                loadUser(user._id);
                Swal.fire('× ×©××¨', '×”×¤×¨×˜×™× × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
            } else Swal.fire('×©×’×™××”', d.error || '×œ× × ×©××¨', 'error');
        });
    }

    function openBasket() {
        const list = document.getElementById('basket-list');
        list.innerHTML = '';
        const count = user.pendingDonations?.length || 0;
        document.getElementById('basket-summary-text').innerText = count > 0 ? `×™×© ×œ×š ${count} ×ª×¨×•××•×ª ×”×××ª×™× ×•×ª ×œ×—×™×•×‘` : '×”×¡×œ ×©×œ×š ×¨×™×§';
        if(count > 0) {
            [...user.pendingDonations].reverse().forEach(item => {
                list.innerHTML += `
                <div class="list-item">
                    <div><span class="fw-bold">â‚ª${item.amount}</span> <small class="text-muted ms-2">${item.note||''}</small></div>
                    <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="deleteItem('${item._id}')">×”×¡×¨</button>
                </div>`;
            });
        }
        document.getElementById('basket-modal').classList.add('open');
    }

    async function deleteItem(itemId) {
        Swal.fire({title:'××•×—×§...', timer: 1000, didOpen:()=>Swal.showLoading(), showConfirmButton:false});
        await fetch(`${API}/delete-pending`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId: user._id, donationId: itemId})});
        await loadUser(user._id); 
        openBasket(); 
    }

    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function openSettings() { document.getElementById('settings-modal').classList.add('open'); }
    function logout() { localStorage.removeItem('userId'); location.reload(); }
    function resetCard() { if(confirm('×œ××—×•×§ ×›×¨×˜×™×¡?')) fetch(`${API}/reset-token`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:user._id})}).then(()=>loadUser(user._id)); }

    function sendCode() {
        const val = document.getElementById('login-val').value;
        const code = Math.floor(1000+Math.random()*9000);
        const payload = { code };
        if(val.includes('@')) payload.email = val; else payload.phone = val;
        fetch(`${API}/update-code`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        document.getElementById('btn-send').classList.add('d-none');
        document.getElementById('otp-area').classList.remove('d-none');
        document.getElementById('btn-verify').classList.remove('d-none');
    }
    
    function verifyCode() {
        const val = document.getElementById('login-val').value;
        const code = document.getElementById('otp-val').value;
        const payload = { code };
        if(val.includes('@')) payload.email = val; else payload.phone = val;
        fetch(`${API}/verify-auth`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
        .then(r=>r.json()).then(d => {
            if(d.success) loadUser(d.user._id); else Swal.fire('×©×’×™××”', '×§×•×“ ×©×’×•×™', 'error');
        });
    }
</script>
</body>
</html>
